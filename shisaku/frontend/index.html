﻿<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AI Avatar – STT / Text → Gemini → COEIROINK → VRM</title>
  <link rel="stylesheet" href="./style.css?v=rev2" />

  <!-- three / three-vrm / three-vrm-animation をCDNから読み込む（バージョン整合） -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.177.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/",
      "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3/lib/three-vrm.module.min.js",
      "@pixiv/three-vrm-animation": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm-animation@3.4.2/lib/three-vrm-animation.module.min.js"
    }
  }
  </script>
</head>
<body class="auto">
  <div id="app-frame">
  <!-- 左上UI：録音開始/停止 -->
  <div id="ui" class="glass-panel control-panel">
    <button id="recBtn">録音開始</button>
    <button id="stopBtn" disabled>録音停止</button>
  </div>

  <!-- VRM Upload Panel -->
  <div id="vrm-panel" class="glass-panel stack-panel">
    <div class="panel-title">VRM変更</div>
    <input type="file" id="vrmInput" accept=".vrm,model/gltf-binary" style="display: none;">
    <div class="panel-actions">
      <button id="vrmUploadBtn" type="button">VRMをアップロード</button>
      <button id="vrmReset" type="button">デフォルト</button>
    </div>
    <div id="vrmStatus" class="panel-note">VRM: 読み込み待ち</div>
  </div>

  <!-- 右上モード選択バー＋ステータス -->
  <div id="style-bar" class="glass-panel style-panel">
    <div class="panel-group">
      <label for="styleSelect">モード:</label>
      <select id="styleSelect">
        <option value="auto">オート（自動）</option>
        <option value="1">のーまる (1)</option>
        <option value="7">いっしょうけんめい (7)</option>
        <option value="40">ごきげん (40)</option>
        <option value="45">どやがお (45)</option>
        <option value="41">ふくれっつら (41)</option>
        <option value="42">しょんぼり (42)</option>
        <option value="43">ないしょばなし (43)</option>
        <option value="44">ひっさつわざ (44)</option>
        <option value="46">ぬむぬむ (46)</option>
        <option value="47">ぱじゃまぱーてぃー (47)</option>
      </select>
    </div>
    <div class="panel-group">
      <label for="chatEngineSelect">会話エンジン:</label>
      <select id="chatEngineSelect">
        <option value="cloud" selected>クラウド（Gemini）</option>
        <option value="local">ローカル（Gemma3:12b）</option>
        <option value="local4">ローカル（Gemma3:4b）</option>
      </select>
    </div>
    <div id="mode-bar" class="panel-group" hidden>
      <label for="modeSelect">表示モード:</label>
      <select id="modeSelect">
        <option value="auto" selected>自動</option>
        <option value="pc">PCモード</option>
        <option value="mobile">スマホモード</option>
      </select>
    </div>
    <div id="autoTtsStatus" class="panel-note">
      System: 手動モード中
    </div>
  </div>

  <!-- 右下：モーション再生バー -->
  <div id="motion-bar" class="glass-panel motion-panel">
    <label>モーション:
      <select id="motionSelect">
  <option value="全身を見せる">全身を見せる</option>
  <option value="挨拶">挨拶</option>
  <option value="Vサイン">Vサイン</option>
  <option value="モデルポーズ">モデルポーズ</option>
  <option value="回る">回る</option>
  <option value="屈伸運動">屈伸運動</option>
  <option value="撃つ">撃つ</option>
</select>
    </label>
    <button id="motionPlay">再生</button>
    <button id="motionStop">停止</button>
    <label><input type="checkbox" id="motionLoop" checked> ループ</label>
    <label class="range-label">速度 <input id="motionSpeed" type="range" min="0.25" max="2.0" step="0.05" value="1.0"></label>
    <div class="panel-group">
      <input id="motionSeek" type="range" min="0" max="1" step="0.001" value="0">
      <span id="motion-time"><span id="motionCur">0.00</span> / <span id="motionDur">0.00</span>s</span>
    </div>
  </div>

  <!-- 再生用オーディオ（口パクに接続） -->
  <audio id="replyAudio" crossorigin="anonymous" playsinline></audio>

  <!-- VRM用キャンバス -->
  <canvas id="c"></canvas>

  <!-- 下部テキスト入力 -->
  <div id="chat-box" class="glass-panel chat-panel">
    <input type="text" id="chat-input" placeholder="メッセージを入力..." />
    <button id="chat-send">送信</button>
    <button id="fullscreenToggle" title="全画面切替">全画面</button>
  </div>

  <!-- Conversation Log -->
  <div id="chat-log" class="glass-panel chat-log-panel">
  </div>

  <!-- Transcript Toggle -->
  <button id="log-toggle" type="button">セリフ一覧</button>

  <!-- Transcript Modal -->
  <div id="log-modal">
    <div class="log-box">
      <div class="log-box__header">
        <div>セリフ一覧</div>
        <button id="log-close" type="button">閉じる</button>
      </div>
      <div id="log-list"></div>
    </div>
  </div>
  
  <div id="layout-editor-panel" class="glass-panel layout-editor-panel" hidden>
    <div class="layout-editor-header">
      <span id="layout-editor-title">編集対象: <strong id="layout-editor-target">なし</strong></span>
      <button id="layout-editor-close" type="button">終了</button>
    </div>
    <div class="layout-editor-field">
      <label for="layout-scale">拡大率</label>
      <input id="layout-scale" type="range" min="0.6" max="2.0" step="0.05" value="1" />
      <span id="layout-scale-value">1.00</span>
    </div>
    <div class="layout-editor-field">
      <label for="layout-left">横位置</label>
      <input id="layout-left" type="number" step="1" />
      <span class="unit">px</span>
    </div>
    <div class="layout-editor-field">
      <label for="layout-top">縦位置</label>
      <input id="layout-top" type="number" step="1" />
      <span class="unit">px</span>
    </div>
    <div class="layout-editor-field">
      <label for="layout-width">横幅</label>
      <input id="layout-width" type="number" min="120" step="1" />
      <span class="unit">px</span>
    </div>
    <div class="layout-editor-field">
      <label for="layout-height">縦幅</label>
      <input id="layout-height" type="number" min="80" step="1" />
      <span class="unit">px</span>
    </div>
    <div class="layout-editor-actions">
      <button id="layout-reset-current" type="button">選択リセット</button>
      <button id="layout-reset-all" type="button">全てリセット</button>
      <button id="layout-save" type="button">保存</button>
    </div>
  </div>

  <!-- レイアウト編集モードの開始/完了ボタン -->
  <button id="layout-edit-toggle" type="button" hidden>編集モードを開始</button>

  <!-- 新しい「各種設定」ボタン -->
  <button id="settings-toggle" type="button">各種設定</button>

  <!-- 新しい設定パネル -->
  <div id="main-settings-panel" class="glass-panel stack-panel" hidden>
    <button id="open-camera-settings" type="button">カメラ設定</button>
    <button id="open-layout-editor" type="button">レイアウト編集</button>
  </div>

  <!-- 追加: カメラ設定値表示パネル -->
  <div id="camera-debug-panel" class="glass-panel stack-panel" hidden>
    <div class="panel-title camera-panel-header">
      <span class="camera-panel-title">カメラ設定</span>
      <div class="camera-panel-actions">
        <button id="fixInitialCamBtn" type="button">初期位置を固定</button>
        <button id="resetCamBtn" type="button">リセット</button>
        <button id="close-camera-settings" type="button">閉じる</button>
      </div>
    </div>
    <div class="camera-input-group">
      <span class="camera-input-label">Position</span>
      <input type="number" step="0.05" id="cam-pos-x">
      <input type="number" step="0.05" id="cam-pos-y">
      <input type="number" step="0.05" id="cam-pos-z">
    </div>
    <div class="camera-input-group">
      <span class="camera-input-label">Target</span>
      <input type="number" step="0.05" id="cam-tgt-x">
      <input type="number" step="0.05" id="cam-tgt-y">
      <input type="number" step="0.05" id="cam-tgt-z">
    </div>
    <div style="margin-top: 4px;">
      <strong>Distance:</strong> <span id="cam-dist-val">0</span>
    </div>
  </div>

  <!-- Timer Toggle (visible in minimal UI) -->
  <button id="timer-toggle" type="button">タイマー非表示</button>

  </div>
  <!-- Three.js / VRM 制御スクリプト -->
  <script type="module" src="./main.js?v=rev3"></script>

  <!-- 終了ボタン用スクリプト（main.jsに触らず独立） -->
  <script>
    const exitBtn = document.getElementById("exitBtn");
    const openLog = document.getElementById("openLog");
    const exitPanel = document.getElementById("exit-panel");
    let keepCoeiro = document.getElementById("keepCoeiro");
    if (!keepCoeiro && exitPanel) {
      const wrap = document.createElement("label");
      wrap.style.marginLeft = "8px";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.id = "keepCoeiro";
      cb.checked = true;
      wrap.appendChild(cb);
      wrap.appendChild(document.createTextNode(" COEIROINKを残す"));
      exitPanel.insertBefore(wrap, exitBtn);
      keepCoeiro = cb;
    }
    let reloadBtn = document.getElementById("reloadBtn");
    if (!reloadBtn && exitPanel) {
      const btn = document.createElement("button");
      btn.id = "reloadBtn";
      btn.textContent = "再読み込み";
      btn.style.background = "#555";
      btn.style.marginLeft = "8px";
      exitPanel.insertBefore(btn, exitBtn);
      reloadBtn = btn;
    }
    if (reloadBtn) reloadBtn.addEventListener("click", () => location.reload());
    if (exitBtn) {
      exitBtn.addEventListener("click", async () => {
        try {
          const show = openLog && openLog.checked ? 1 : 0;
          const keep = keepCoeiro && keepCoeiro.checked ? 1 : 0;
          await fetch(`/api/exit?show_log=${show}&keep_coeiro=${keep}`, { method: "GET" });
        } finally {
          window.open("", "_self");
          window.close();
        }
      });
    }
  </script>
</body>
</html>
